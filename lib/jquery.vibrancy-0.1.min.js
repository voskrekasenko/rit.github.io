/*!
 *  vibrancy.js - v0.1
 *  A jQuery plugin for adding stylish frosted glass effects over images.
 *  http://dietrich-stein.github.io/vibrancy.js
 *
 *  Copyright (c) 2014 Dietrich Stein
 *  This content is released under the MIT license.
 */

!function(a){function b(b,d){this.el=b,this.settings=a.extend({},e,d),this._defaults=e,this._name=c,this.init()}var c="vibrancy",d=0,e={panelClass:"panel",backgroundSrc:""};a.extend(b.prototype,{init:function(){var b=this;if(""===a.trim(b.settings.backgroundSrc))throw"The backgroundSrc option must be set to a valid image source.";if(b.$target=a(b.el),b.$target.css("position","relative"),b.targetW=b.$target.width(),b.targetH=b.$target.height(),b.$panels=a("."+b.settings.panelClass,b.$target),0===b.$panels.length)throw'Unable to find any elements with a class matching the panelClass setting "'+b.settings.panelClass+'" within the targeted element.';b.vibObjects=[],b.imgObjects=[],b.imgSources=[],b.dataAttrs=["vibrance","blur","brightness"],b.$panels.each(function(c,e){var f=a(e),g=f.position();panelCoords=[],panelCoords.w=f.outerWidth(),panelCoords.h=f.outerHeight(),panelCoords.top=g.top,panelCoords.right=b.targetW-(g.left+panelCoords.w),panelCoords.bottom=b.targetH-(g.top+panelCoords.h),panelCoords.left=g.left;var h=b._name+"_canvas_"+d;d++,a("<canvas>").attr({id:h,width:panelCoords.w,height:panelCoords.h}).css({display:"none",position:"absolute",top:panelCoords.top,left:panelCoords.left,right:panelCoords.right,bottom:panelCoords.bottom}).appendTo(b.$target);var i=a("#"+h),j={canvas:i,context:i[0].getContext("2d"),coords:panelCoords,panel:f};a.each(b.dataAttrs,function(a,b){j[b]=j.panel.attr("data-vibrancy-"+b)?parseInt(j.panel.attr("data-vibrancy-"+b)):0}),b.vibObjects.push(j)}),this.loadBackground(b.settings.backgroundSrc)},loadBackground:function(a){var b=this,c=b.imgSources.indexOf(a);if(c>-1)b.$target.css("background-image","url("+a+")"),b.renderPanels(b.imgObjects[c]);else{var d=new Image;d.width=b.targetW,d.height=b.targetH,d.src=a,d.onload=function(){b.$target.css("background-image","url("+a+")"),b.imgSources.push(a),b.imgObjects.push(d),b.renderPanels(d)}}},renderPanels:function(b){var c=this;a.each(c.vibObjects,function(a,c){c.context.drawImage(b,c.coords.left,c.coords.top,c.coords.w,c.coords.h,0,0,c.coords.w,c.coords.h),Caman(c.canvas[0],function(){this.reloadCanvasData(),this.vibrance(c.vibrance).brightness(c.brightness).stackBlur(c.blur).render(),c.canvas.is(":visible")||c.canvas.stop(!0,!1).fadeIn(100,function(){})})})}}),a.fn[c]=function(d){return this.each(function(){a.data(this,c)||a.data(this,c,new b(this,d))}),this}}(jQuery,window,document);